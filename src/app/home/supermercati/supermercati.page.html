<ion-content>
  <div class="location-error" *ngIf="locationError">
    <ion-chip color="warning">
      <ion-icon name="location-outline"></ion-icon>
      <ion-label>{{locationError}}</ion-label>
    </ion-chip>
  </div>

  <div class="map-container">
    <div id="map"></div>
  </div>

  <div class="supermarkets-list">
    <div class="supermarkets-header">
      <h2 class="supermarkets-title">
        {{ userPosition ? 'Supermercati più vicini a te:' : 'Lista supermercati:' }}
      </h2>
      <ion-button *ngIf="isAdminOrManager" fill="outline" (click)="openAddSupermarketModal()" class="add-supermarket-btn">
        <ion-icon slot="start" name="add-circle-outline" class="add-supermarket-icon"></ion-icon>
        <span class="add-supermarket-label">Aggiungi</span>
      </ion-button>
    </div>
    <swiper-container
      slides-per-view="auto"
      space-between="12"
      centered-slides="false"
      pagination="true"
      navigation="true"
      class="supermarket-cards-swiper"
      dir="ltr"
    >
      <swiper-slide *ngFor="let supermarket of supermarkets">
        <div class="supermarket-card"
             [attr.data-supermarket-id]="supermarket.id"
             [class.active]="selectedSupermarket?.id === supermarket.id"
             (click)="selectSupermarket(supermarket)">
          <div class="card-image">
            <img [src]="getStoreImage(supermarket.name)"
                 [alt]="supermarket.name"
                 loading="lazy"
                 draggable="false">
          </div>
          <div class="card-content">
            <h3>{{supermarket.name}}</h3>
            <p>
              {{supermarket.address}}
              <span class="distance" *ngIf="getDistanceFromUser(supermarket.latitude, supermarket.longitude)">
                •  {{getDistanceFromUser(supermarket.latitude, supermarket.longitude)}}
              </span>
            </p>
            <div class="card-actions">
              <ion-button fill="clear" size="small" (click)="openInMaps(supermarket, $event)">
                <ion-icon name="navigate-outline"></ion-icon>
                Navigazione
              </ion-button>
              <ion-button fill="clear" size="small" (click)="selectAndNavigate(supermarket, $event)">
                <ion-icon name="storefront-outline"></ion-icon>
                Seleziona
              </ion-button>
            </div>
          </div>
        </div>
      </swiper-slide>
      <div class="loading-container" *ngIf="isLoading">
        <ion-spinner></ion-spinner>
        <ion-label>Caricamento supermercati...</ion-label>
      </div>
    </swiper-container>
  </div>

  <ng-container *ngIf="addSupermarketModalOpen">
    <ion-modal [isOpen]="addSupermarketModalOpen" (didDismiss)="closeAddSupermarketModal()" class="add-supermarket-modal">
      <ng-template>
        <ion-header>
          <ion-toolbar color="primary">
            <ion-title>Aggiungi Supermercato</ion-title>
            <ion-buttons slot="end">
              <ion-button (click)="closeAddSupermarketModal()">
                <ion-icon name="close-outline"></ion-icon>
              </ion-button>
            </ion-buttons>
          </ion-toolbar>
        </ion-header>
        <ion-content>
          <form (ngSubmit)="submitAddSupermarket()" #addSupermarketForm="ngForm" autocomplete="off">
            <ion-list lines="full">
              <ion-item>
                <ion-label position="floating">Nome</ion-label>
                <ion-input required [(ngModel)]="newSupermarket.name" name="name"></ion-input>
              </ion-item>
              <ion-item>
                <ion-label position="floating">Indirizzo</ion-label>
                <ion-input required [(ngModel)]="newSupermarket.address" name="address" (ionInput)="onAddressInputDebounced()" autocomplete="off"></ion-input>
              </ion-item>
              <ion-item *ngIf="addressSuggestions.length > 0">
                <ion-list>
                  <ion-item button *ngFor="let suggestion of addressSuggestions" (click)="selectAddressSuggestion(suggestion)">
                    {{suggestion.display_name}}
                  </ion-item>
                </ion-list>
              </ion-item>
              
            </ion-list>
            <ion-footer>
              <ion-toolbar>
                <ion-button expand="block" type="submit" [disabled]="!addSupermarketForm.form.valid || isSubmitting">
                  <ion-icon name="save-outline" slot="start"></ion-icon>
                  Salva
                </ion-button>
              </ion-toolbar>
            </ion-footer>
          </form>
        </ion-content>
      </ng-template>
    </ion-modal>
  </ng-container>
</ion-content>